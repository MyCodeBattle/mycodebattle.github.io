---
title: TCP/IP 协议族 - IPv4 笔记
layout: post
date: 2016-04-19
categories: TCP/IP
---

# 引言

IP 是一种不可靠的无连接数据协议，依靠更高层来解决数据损伤、丢失等问题。

# 数据报

网络层的分组称为**数据报**。

![ip](http://www.zzxueshihou.com/uploads/allimg/120305/1_120305175054_1.jpg)

- 首部长度,  定义了数据报首部的长度，单位是 4 字节。
- 总长度, 定义了数据报总长度。数据长度 = 总长度 - 首部长度。
为什么需要这个东西呢？如果数据报被填充了，就能根据这个得出真实的数据有多少。
- 标识， 用于分片.
- 标志，用于分片。
- 分片偏移，用于分片。
- 生存时间，控制数据报的最大跳数。如果变成0就丢弃数据报，可以用来限制数据报在一个局域网内。
- 协议，标识封装了哪个上层协议。

# 分片

## 最大传送单元 (MTU)

数据链路层限制了可封装在一个帧中的最大长度。所以有时候数据报要分片。

第一次分片是被运输层，它会把数据分成 IP 与源点使用的数据链路层可接纳的大小。
如果已经分片的数据报遇到更小的 MTU 网络，这些数据报还会分片。

数据报可以被任意路由器分片，但是重组只能在目的主机上进行。

分片的时候，必须改变三个字段的值：

- 标志
- 分片偏移
- 总长度

其余的各字段必须被复制。

## 与分片有关的字段

- 标识 (identification)，这个 16 位字段标志了从源主机发出的一个数据报。此标志与源 IP 地址的组合必须唯一地确定这个数据报，也就是说，
所有的分片都具有相同的 identification。
identification 是由一个计数器控制的，每产生一个数据报计数器加一。
- 标志 (flag)，这是 3 位的字段。第一位保留，第二位称为`不分片`位。如果这个值是1，机器就不能对数据报分片，如果无法通过任何可用的物理网络，
就丢弃数据报，并向源主机发送 ICMP 差错报文。第三位是`还有分片`位，如果是 1，说明不是最后一个。
- 分片偏移，这个 13 位字段表示的分片在整个数据报中的相对位置，偏移值以 **8字节** 为单位，因为他只有 13 位，要想跟上 16 位只能乘以 8 了。

# 选项

## 格式 

### 类型

共8位。


- 复制（1位），若是0，表示选项必须仅仅复制到第一个分片，否则表示选项必须复制到所有分片中。
- 类别（2位），定义了该选项的一般用途，若是00，表示选项用作数据报的控制。若是 10，表示用作排错和管理。

### 长度

定义了选项的总长度。


### 值

包含某些特定选项所需数据。

## 选项类型

### 无操作选项

是个 1 字节的选项，用作选项和选项之间的填充符。
00000001.

### 选项结束选项

只能用作最后一个选项。
00000000.

### 记录路由选项

00000111，用来记录经过的路由。

### 严格路由选项

10001001，如果数据报通过了某个未被列入的路由器，将丢弃并发送差错报文。

### 不严格路由选项

10000011，表中列出的路由器必须通过，但是可以通过其他的路由器。

### 时间戳

用来记录路由器处理数据报的时间。

---

上面六个选项中，不复制的选项开头是0，用于数据报控制的选项第 2、3 个位置是 00，否则是 10。

# 检验和

还没理解。

# 安全性

## 安全问题

### 分组窃取

入侵者可以窃取一个分组。

但是如果加密了的话窃取了也看不到内容。

### 分组篡改

这个可以通过**完整性机制**检测到。

### IP 伪装

可以通过**起源鉴别机制**检测 。


